name: Security Audit CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  security-audit:
    name: üõ°Ô∏è Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Security Audit (self-scan)
        id: audit
        run: |
          chmod +x scripts/audit.sh
          echo "## üõ°Ô∏è Security Audit Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Run scan, capture output
          set +e
          OUTPUT=$(bash scripts/audit.sh --json . 2>&1)
          EXIT_CODE=$?
          set -e

          # Parse JSON results
          TOTAL=$(echo "$OUTPUT" | grep -o '"totalFindings": [0-9]*' | grep -o '[0-9]*')
          CRITICAL=$(echo "$OUTPUT" | grep -o '"critical": [0-9]*' | grep -o '[0-9]*')
          WARNING=$(echo "$OUTPUT" | grep -o '"warning": [0-9]*' | grep -o '[0-9]*')
          FILES=$(echo "$OUTPUT" | grep -o '"filesScanned": [0-9]*' | grep -o '[0-9]*')

          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
          echo "warning=$WARNING" >> $GITHUB_OUTPUT

          if [ "$EXIT_CODE" -eq 0 ]; then
            echo "‚úÖ **All clean!** Scanned $FILES files, no findings." >> $GITHUB_STEP_SUMMARY
          else
            echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Files scanned | $FILES |" >> $GITHUB_STEP_SUMMARY
            echo "| üî¥ Critical | $CRITICAL |" >> $GITHUB_STEP_SUMMARY
            echo "| üü° Warning | $WARNING |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            echo "$OUTPUT" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

          # Fail on critical
          if [ "$EXIT_CODE" -eq 2 ]; then
            echo "::error::üî¥ Critical security findings detected!"
            exit 1
          fi

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const exitCode = '${{ steps.audit.outputs.exit_code }}';
            const total = '${{ steps.audit.outputs.total }}';
            const critical = '${{ steps.audit.outputs.critical }}';
            const warning = '${{ steps.audit.outputs.warning }}';

            let body;
            if (exitCode === '0') {
              body = '## üõ°Ô∏è Security Audit\n\n‚úÖ **All clean!** No security findings detected.';
            } else if (exitCode === '2') {
              body = `## üõ°Ô∏è Security Audit\n\n‚ùå **Failed** ‚Äî found ${critical} critical and ${warning} warning issues.\n\nPlease check the Actions log for details.`;
            } else {
              body = `## üõ°Ô∏è Security Audit\n\n‚ö†Ô∏è **Warnings** ‚Äî found ${warning} warning-level issues.\n\nPlease review the Actions log for details.`;
            }

            // Find and update existing comment or create new
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            const botComment = comments.find(c => c.body.includes('## üõ°Ô∏è Security Audit'));

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }
